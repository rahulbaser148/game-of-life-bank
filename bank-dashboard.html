<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Game of Life Bank - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            color: #333;
        }
        .hidden-section {
            display: none;
        }
        .colorful-player-section {
            background: linear-gradient(90deg, #e3ffe7 0%, #d9e7ff 100%);
            padding-top: 1rem;
            padding-bottom: 1rem;
            box-shadow: inset 0 8px 10px -6px rgba(0, 0, 0, 0.3),
                        inset 0 -8px 10px -6px rgba(0, 0, 0, 0.3);
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        .modal-overlay:not(.hidden-section) {
            display: flex;
        }
        .modal-content {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            width: 100%;
            max-width: 28rem; /* Max width for larger screens */
            margin: 0 1rem;
            position: relative;
            overflow: hidden; /* Important for the slider */
        }
        .arrow-icon {
            cursor: pointer;
            width: 24px;
            height: 24px;
            fill: none;
            stroke: currentColor;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
            color: #60a5fa;
            transition: color 0.2s ease-in-out;
        }
        .arrow-icon:hover {
            color: #3b82f6;
        }
        
        @media (max-width: 639px) {
            .mobile-slider-container {
                display: flex;
                overflow-x: auto;
                scroll-snap-type: x mandatory;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none; 
            }
            .mobile-slider-container::-webkit-scrollbar {
                display: none;
            }
            .mobile-slider-item {
                flex: 0 0 90%;
                scroll-snap-align: center;
                margin: 0 5%;
            }
            .mobile-hidden {
                display: none;
            }
        }

        /* ▼▼▼ START OF CSS FOR MODAL SLIDER ▼▼▼ */
        .modal-tab-button {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            color: #6b7280; /* gray-500 */
            font-weight: 600;
            white-space: nowrap;
        }
        .modal-tab-button.active {
            color: #1d4ed8; /* blue-700 */
            border-bottom-color: #2563eb; /* blue-600 */
        }
        .modal-slider-wrapper {
            overflow: hidden;
            width: 100%;
        }
        .modal-slider {
            display: flex;
            width: 400%; /* Four panels */
            transition: transform 0.4s ease-in-out;
        }
        .modal-panel {
            width: 25%; /* Each panel takes one-quarter of the 400% width */
            padding: 1rem 0.25rem;
            box-sizing: border-box;
        }
        /* Classes to trigger the slide */
        .show-panel-2 .modal-slider { transform: translateX(-25%); }
        .show-panel-3 .modal-slider { transform: translateX(-50%); }
        .show-panel-4 .modal-slider { transform: translateX(-75%); }
        /* ▲▲▲ END OF CSS FOR MODAL SLIDER ▲▲▲ */
    </style>
</head>
<body>
    <img src="Game of Life Logo.jpeg"
             alt="The Game of Life Bank Logo"
             class="absolute top-4 right-4 h-12 w-auto object-contain z-10"> 

    <section id="gameStatusSection" class="text-center mt-12 mb-8 p-4 bg-white rounded-xl shadow-lg border border-blue-200 mx-auto max-w-2xl">
        <p id="sessionMessage" class="text-lg text-gray-700">Loading game session...</p>
        <div class="flex items-center justify-center flex-wrap gap-2 mt-2" id="sessionIdContainer">
            <p class="text-sm text-gray-500">Session ID: <span id="currentSessionId"></span></p>
            <button id="endSessionBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded-full text-sm shadow-md transition-colors duration-200 hidden-section">
                End Session
            </button>
        </div>
    </section>

    <section id="playerCardsSection" class="mb-12 hidden-section w-full colorful-player-section">
        <div id="playersGrid" class="sm:grid sm:grid-cols-2 lg:grid-cols-4 sm:gap-6 sm:px-6 lg:px-8 mobile-slider-container">
        </div>
    </section>
    
    <section id="transactionsSection" class="mb-12 hidden-section w-full max-w-6xl mx-auto px-4">
        <h2 class="text-2xl sm:text-3xl font-bold text-blue-700 mb-6 text-center">Recent Transactions</h2>
        <div class="overflow-x-auto bg-white rounded-xl shadow-lg p-4 border border-blue-200">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-blue-100">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-blue-700 uppercase tracking-wider mobile-hidden">Sr No.</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-blue-700 uppercase tracking-wider">Player Name</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-blue-700 uppercase tracking-wider mobile-hidden">Action</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-blue-700 uppercase tracking-wider">Amount</th>
                    </tr>
                </thead>
                <tbody id="transactionsTableBody" class="bg-white divide-y divide-gray-200">
                </tbody>
            </table>
        </div>
    </section>

    <!-- ▼▼▼ START OF HTML MODIFICATIONS ▼▼▼ -->
    <div id="playerModal" class="modal-overlay hidden-section">
        <div id="modalContent" class="modal-content">
            <button id="closeModalBtn" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 text-2xl font-bold z-20">&times;</button>
            <h3 class="text-2xl font-bold text-blue-700 mb-2 text-center">Player Details</h3>
            
            <!-- Tab Buttons -->
            <div id="modalTabs" class="flex justify-around border-b border-gray-200 mb-2">
                <button data-panel="1" class="modal-tab-button active">Info</button>
                <button data-panel="2" class="modal-tab-button">Send</button>
                <button data-panel="3" class="modal-tab-button">Loan</button>
                <button data-panel="4" class="modal-tab-button">Profession</button>
            </div>

            <!-- Slider Wrapper -->
            <div class="modal-slider-wrapper">
                <div id="modalSlider" class="modal-slider">
                    <!-- Panel 1: Information -->
                    <div class="modal-panel">
                        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-start gap-2">
                            <div>
                                <p class="text-xl text-blue-800 font-semibold"><span id="modalPlayerName"></span></p>
                                <p class="text-base text-amber-500"><span id="modalPlayerProfession"></span></p>
                                <p class="text-sm text-gray-500">Acc No: <span id="modalPlayerAccountNo"></span></p>
                            </div>
                            <div class="text-left sm:text-right">
                                <p class="text-sm text-gray-500">Loan</p>
                                <p class="text-lg font-bold text-red-600"><span id="modalPlayerLoan"></span></p>
                            </div>
                        </div>
                    </div>
                    <!-- Panel 2: Send Money & Payday -->
                    <div class="modal-panel">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-4">
                            <div>
                                <label for="amountInput" class="block text-sm font-medium text-gray-700">Send Money</label>
                                <input type="number" id="amountInput" placeholder="$1,000s" class="w-full p-2 border border-gray-300 rounded-md" min="0" step="1000">
                                <button id="sendMoneyBtn" class="mt-2 w-full bg-black hover:bg-gray-800 text-white font-bold py-2 px-6 rounded-md">Send</button>
                            </div>
                            <div class="text-center">
                                 <label class="block text-sm font-medium text-gray-700">Payday Amount</label>
                                 <span id="salaryDisplay" class="block text-2xl font-bold italic text-gray-800 mt-1">$0</span>
                                 <div class="mt-2 flex justify-center items-center gap-2">
                                     <button id="paydayBtn" class="bg-black hover:bg-gray-800 text-white font-bold py-2 px-4 rounded-md disabled:opacity-50">PAYDAY</button>
                                     <button id="investBtn" class="bg-black hover:bg-gray-800 text-white font-bold py-2 px-4 rounded-md hidden disabled:opacity-50">INVEST</button>
                                 </div>
                            </div>
                        </div>
                    </div>
                    <!-- Panel 3: Loan Management -->
                    <div class="modal-panel flex items-center justify-center">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-8 gap-y-4">
                        
                            <div class="flex flex-col items-center">
                                <input type="number" id="loanAmountInput" placeholder="$20,000" class="w-full p-2 border border-gray-300 rounded-md" min="0" step="20000">
                                <button id="takeLoanBtn" class="mt-2 w-full bg-black hover:bg-gray-800 text-white font-bold py-2 px-6 rounded-md">Loan</button>
                            </div>

                            <div class="flex items-center justify-center sm:justify-start">
                                <input type="number" id="interestRateInput" class="w-16 p-2 border border-gray-300 rounded-md" value="25" min="0" step="5">
                                <span class="font-bold text-gray-600 mx-2">%</span>
                                <button id="setInterestBtn" class="bg-black hover:bg-gray-800 text-white font-bold py-2 px-4 rounded-md">SET</button>
                            </div>

                        </div>
                    </div>
                    <!-- Panel 4: Profession -->
                    <div class="modal-panel">
                        <div id="professionList" class="border border-black p-2 rounded-md flex flex-wrap gap-2">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, query, orderBy, doc, deleteDoc, updateDoc, addDoc, serverTimestamp, getDoc, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = {
          apiKey: "AIzaSyAx2GBREwAJ-VX0x_kueY8IK51E-EvVJqA",
          authDomain: "the-game-of-life-bank.firebaseapp.com",
          projectId: "the-game-of-life-bank",
          storageBucket: "the-game-of-life-bank.firebasestorage.app",
          messagingSenderId: "793225047291",
          appId: "1:793225047291:web:fa24d214f0f762a768545e",
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        let db, auth, userId, currentSessionId = null, currentPlayerIdInModal = null, currentPlayerProfessionInModal = null;
        const sessionMessage = document.getElementById('sessionMessage');
        const sessionIdContainer = document.getElementById('sessionIdContainer');
        const currentSessionIdSpan = document.getElementById('currentSessionId');
        const endSessionBtn = document.getElementById('endSessionBtn');
        const playersGrid = document.getElementById('playersGrid');
        const transactionsTableBody = document.getElementById('transactionsTableBody');
        const playerCardsSection = document.getElementById('playerCardsSection');
        const transactionsSection = document.getElementById('transactionsSection');
        const playerModal = document.getElementById('playerModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const modalPlayerName = document.getElementById('modalPlayerName');
        const modalPlayerProfession = document.getElementById('modalPlayerProfession');
        const modalPlayerAccountNo = document.getElementById('modalPlayerAccountNo');
        const modalPlayerLoan = document.getElementById('modalPlayerLoan');
        const amountInput = document.getElementById('amountInput');
        const sendMoneyBtn = document.getElementById('sendMoneyBtn');
        const loanAmountInput = document.getElementById('loanAmountInput');
        const takeLoanBtn = document.getElementById('takeLoanBtn');
        const paydayBtn = document.getElementById('paydayBtn');
        const salaryDisplay = document.getElementById('salaryDisplay');
        const professionList = document.getElementById('professionList');
        const interestRateInput = document.getElementById('interestRateInput');
        const setInterestBtn = document.getElementById('setInterestBtn');
        const investBtn = document.getElementById('investBtn');
        const professions = ["BUSINESS-M", "BUSINESS-O", "DOCTOR", "LAWYER", "TEACHER", "JOURNALIST", "PHYSICIST", "UNIVERSITY DEGREE"];
        const professionIncomes = { "DOCTOR": 50000, "LAWYER": 50000, "TEACHER": 20000, "PHYSICIST": 30000, "JOURNALIST": 24000, "BUSINESS-M": 12000, "BUSINESS-O": 12000, "UNIVERSITY DEGREE": 16000, "UNEMPLOYED": 0 };
        const GOL_BANK_ACCOUNT = { name: "GOL Bank", accountNo: "GLB-3000" };

        // ▼▼▼ START OF JAVASCRIPT MODIFICATION ▼▼▼
        const colorGradients = {
            Red: 'linear-gradient(to bottom right, #fecaca, #f87171)',
            Yellow: 'linear-gradient(to bottom right, #fef08a, #facc15)',
            Orange: 'linear-gradient(to bottom right, #fed7aa, #fb923c)',
            Blue: 'linear-gradient(to bottom right, #bfdbfe, #60a5fa)',
            White: 'linear-gradient(to bottom right, #f9fafb, #e5e7eb)',
            Green: 'linear-gradient(to bottom right, #bbf7d0, #4ade80)',
            Purple: 'linear-gradient(to bottom right, #e9d5ff, #c084fc)', 
            Pink: 'linear-gradient(to bottom right, #fbcfe8, #f472b6)'
        };
        // ▲▲▲ END OF JAVASCRIPT MODIFICATION ▲▲▲

        const modalTabs = document.getElementById('modalTabs');
        const modalContent = document.getElementById('modalContent');

        modalTabs.addEventListener('click', (e) => {
            if (e.target.matches('.modal-tab-button')) {
                const panelNumber = e.target.dataset.panel;
                
                // Update active tab button
                modalTabs.querySelectorAll('.modal-tab-button').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');

                // Slide to the correct panel
                modalContent.className = 'modal-content'; // Reset classes
                if (panelNumber > 1) {
                    modalContent.classList.add(`show-panel-${panelNumber}`);
                }
            }
        });
        

        async function initializeFirebase() { /* Function is unchanged */
            closeModal();
            try {
                if (!firebaseConfig.projectId || firebaseConfig.projectId === "YOUR_PROJECT_ID") throw new Error("Firebase config missing");
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                try {
                    if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken);
                    else await signInAnonymously(auth);
                } catch (authError) { await signInAnonymously(auth); }
                onAuthStateChanged(auth, (user) => {
                    if (user) { userId = user.uid; loadGameSession(); } 
                    else { sessionMessage.textContent = "Error: Could not authenticate."; }
                });
            } catch (error) { console.error("Error initializing Firebase:", error); sessionMessage.textContent = "Error: Could not connect to Firebase."; }
        }
        async function loadGameSession() { /* Function is unchanged */
            currentSessionId = localStorage.getItem('gameSessionId');
            if (currentSessionId) {
                sessionMessage.textContent = "Connected to game session.";
                sessionIdContainer.classList.remove('hidden-section');
                currentSessionIdSpan.textContent = currentSessionId;
                endSessionBtn.classList.remove('hidden-section');
                setupRealtimeListeners(currentSessionId);
            } else {
                sessionMessage.textContent = "No active game session found.";
                sessionIdContainer.classList.add('hidden-section');
                playerCardsSection.classList.add('hidden-section');
                transactionsSection.classList.add('hidden-section');
            }
        }

        // ▼▼▼ START OF JAVASCRIPT MODIFICATION ▼▼▼
        function renderPlayerCards(players) {
            playersGrid.innerHTML = '';
            if (players.length > 0) playerCardsSection.classList.remove('hidden-section');
            else playerCardsSection.classList.add('hidden-section');
            players.forEach(player => {
                const playerColor = player.cardColor || 'White';
                const gradientStyle = colorGradients[playerColor] || colorGradients['White'];
                const cardHtml = `
                <div class="mobile-slider-item">
                    <div class="p-6 rounded-xl shadow-lg hover:shadow-xl transition-shadow duration-300 border h-56 flex flex-col justify-between text-left relative" style="background: ${gradientStyle};">
                        <button class="absolute top-3 right-3 p-1 rounded-full bg-gray-100/50 hover:bg-gray-200/70 focus:outline-none focus:ring-2 focus:ring-blue-500 arrow-button" data-player-id="${player.id}">
                            <svg class="arrow-icon text-gray-800" viewBox="0 0 24 24"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
                        </button>
                        <div>
                            <h3 class="text-xl font-bold text-gray-800 mb-0.5">${player.name.toUpperCase()}</h3>
                            <p class="text-base text-gray-700"><span class="font-medium text-gray-900">${player.profession || 'Unemployed'}</span></p>
                        </div>
                        <div class="w-full">
                            <p class="text-base text-gray-600 mt-1">ACC NO: <span class="font-medium">${player.accountNo}</span></p>
                            <div class="mt-2 w-full h-10 bg-gray-200/50 rounded-sm flex items-center justify-start overflow-hidden">
                               <svg width="100%" height="100%" viewBox="0 0 100 20" preserveAspectRatio="none"><rect x="0" y="0" width="2" height="20" fill="#333" /><rect x="3" y="0" width="1" height="20" fill="#333" /><rect x="5" y="0" width="3" height="20" fill="#333" /><rect x="9" y="0" width="2" height="20" fill="#333" /><rect x="12" y="0" width="1" height="20" fill="#333" /><rect x="14" y="0" width="2" height="20" fill="#333" /><rect x="17" y="0" width="3" height="20" fill="#333" /><rect x="21" y="0" width="1" height="20" fill="#333" /><rect x="23" y="0" width="2" height="20" fill="#333" /><rect x="26" y="0" width="1" height="20" fill="#333" /><rect x="28" y="0" width="2" height="20" fill="#333" /><rect x="31" y="0" width="3" height="20" fill="#333" /><rect x="35" y="0" width="1" height="20" fill="#333" /><rect x="37" y="0" width="2" height="20" fill="#333" /><rect x="40" y="0" width="1" height="20" fill="#333" /><rect x="42" y="0" width="2" height="20" fill="#333" /><rect x="45" y="0" width="3" height="20" fill="#333" /><rect x="49" y="0" width="2" height="20" fill="#333" /><rect x="52" y="0" width="1" height="20" fill="#333" /><rect x="54" y="0" width="2" height="20" fill="#333" /><rect x="57" y="0" width="1" height="20" fill="#333" /><rect x="59" y="0" width="2" height="20" fill="#333" /><rect x="62" y="0" width="3" height="20" fill="#333" /><rect x="66" y="0" width="1" height="20" fill="#333" /><rect x="68" y="0" width="2" height="20" fill="#333" /><rect x="71" y="0" width="1" height="20" fill="#333" /><rect x="73" y="0" width="2" height="20" fill="#333" /><rect x="76" y="0" width="3" height="20" fill="#333" /><rect x="80" y="0" width="1" height="20" fill="#333" /><rect x="82" y="0" width="2" height="20" fill="#333" /><rect x="85" y="0" width="1" height="20" fill="#333" /><rect x="87" y="0" width="2" height="20" fill="#333" /><rect x="90" y="0" width="3" height="20" fill="#333" /><rect x="94" y="0" width="1" height="20" fill="#333" /><rect x="96" y="0" width="2" height="20" fill="#333" /></svg>
                            </div>
                        </div>
                    </div>
                </div>`;
                const cardDiv = document.createElement('div'); cardDiv.innerHTML = cardHtml;
                const actualCard = cardDiv.firstElementChild;
                actualCard.querySelector('.arrow-button').addEventListener('click', () => openPlayerModal(player));
                playersGrid.appendChild(actualCard);
            });
        }
        // ▲▲▲ END OF JAVASCRIPT MODIFICATION ▲▲▲

        function renderTransactions(transactions) { /* Function is unchanged */
            transactionsTableBody.innerHTML = '';
            if (transactions.length > 0) transactionsSection.classList.remove('hidden-section');
            else transactionsSection.classList.add('hidden-section');
            transactions.forEach((transaction, index) => {
                const serialNumber = transactions.length - index;
                let amountColorClass = (transaction.action.includes('Credit') || transaction.action.includes('Paycheck') || transaction.action === 'Loan') ? 'text-green-600' : 'text-red-600';
                 const rowHtml = `<tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 mobile-hidden">${serialNumber}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">${transaction.playerName || transaction.sender || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold ${amountColorClass} mobile-hidden">${transaction.action}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold ${amountColorClass}">$${transaction.amount.toLocaleString()}</td>
                </tr>`;
                transactionsTableBody.insertAdjacentHTML('beforeend', rowHtml);
            });
        }
        function setupRealtimeListeners(sessionId) {
            onSnapshot(collection(db, `artifacts/${appId}/public/data/gameSessions/${sessionId}/players`), (s) => renderPlayerCards(s.docs.map(d=>({id:d.id,...d.data()}))));
            onSnapshot(query(collection(db, `artifacts/${appId}/public/data/gameSessions/${sessionId}/transactions`), orderBy('timestamp','desc')), (s) => renderTransactions(s.docs.map(d=>({id:d.id,...d.data()}))));
        }
        endSessionBtn.addEventListener('click', async () => {
            if (confirm("Are you sure you want to end the current game session?")) {
                try {
                    if (currentSessionId) await deleteDoc(doc(db, `artifacts/${appId}/public/data/gameSessions`, currentSessionId));
                    localStorage.removeItem('gameSessionId'); window.location.href = 'index.html';
                } catch (error) { console.error("Error ending session:", error); alert("Failed to end session."); }
            }
        });

        function openPlayerModal(playerData) { /* Function is unchanged */
            currentPlayerIdInModal = playerData.id;
            currentPlayerProfessionInModal = playerData.profession;
            modalPlayerName.textContent = playerData.name.toUpperCase();
            modalPlayerProfession.textContent = playerData.profession || 'Unemployed';
            modalPlayerAccountNo.textContent = playerData.accountNo;
            modalPlayerLoan.textContent = `$${(playerData.loan || 0).toLocaleString()}`;
            salaryDisplay.textContent = `$${(playerData.currentSalary || professionIncomes[playerData.profession] || 0).toLocaleString()}`;
            interestRateInput.value = playerData.loanInterest || 25;
            if (playerData.profession === 'BUSINESS-M') {
                investBtn.classList.remove('hidden');
            } else {
                investBtn.classList.add('hidden');
            }
            amountInput.value = '';
            loanAmountInput.value = '';
            professionList.innerHTML = '';
            professions.forEach(prof => {
                const button = document.createElement('button');
                button.textContent = prof;
                button.className = `px-3 py-1 border rounded-md text-sm transition-colors duration-200 ${playerData.profession===prof?'bg-blue-500 text-white':'bg-gray-100 text-gray-700 hover:bg-gray-200'}`;
                button.addEventListener('click', () => updateProfession(currentPlayerIdInModal, prof));
                professionList.appendChild(button);
            });
             modalContent.className = 'modal-content';
            modalTabs.querySelectorAll('.modal-tab-button').forEach(btn => btn.classList.remove('active'));
            modalTabs.querySelector('[data-panel="1"]').classList.add('active');

            playerModal.classList.remove('hidden-section');
        }
        function closeModal() { playerModal.classList.add('hidden-section'); currentPlayerIdInModal = null; }
        async function sendMoney() { /* Function is unchanged */
            const amount = parseFloat(amountInput.value);
            if (isNaN(amount) || amount <= 0 || amount % 1000 !== 0) { alert("Please enter a valid amount (multiple of $1,000)."); return; }
            if (!currentPlayerIdInModal || !currentSessionId) return;
            const playerRef = doc(db, `artifacts/${appId}/public/data/gameSessions/${currentSessionId}/players`, currentPlayerIdInModal);
            sendMoneyBtn.disabled = true;
            try {
                const playerSnap = await getDoc(playerRef);
                if (playerSnap.exists()) {
                    await updateDoc(playerRef, { balance: (playerSnap.data().balance || 0) + amount });
                    await addDoc(collection(db, `artifacts/${appId}/public/data/gameSessions/${currentSessionId}/transactions`), { playerName: modalPlayerName.textContent, action: 'Credit (from Bank)', amount, timestamp: serverTimestamp() });
                    alert(`Sent $${amount} to ${modalPlayerName.textContent}.`);
                }
            } catch (error) { console.error("Error sending money:", error); alert("Failed to send money."); 
            } finally { sendMoneyBtn.disabled = false; }
            amountInput.value = '';
        }
        async function takeLoan() { /* Function is unchanged */
            const loanAmount = parseFloat(loanAmountInput.value);
            if (isNaN(loanAmount) || loanAmount <= 0 || loanAmount % 20000 !== 0) { alert("Loan amount must be a multiple of $20,000."); return; }
            if (!currentPlayerIdInModal || !currentSessionId) return;
            const playerRef = doc(db, `artifacts/${appId}/public/data/gameSessions/${currentSessionId}/players`, currentPlayerIdInModal);
            takeLoanBtn.disabled = true;
            try {
                const playerSnap = await getDoc(playerRef);
                if (playerSnap.exists()) {
                    const d = playerSnap.data();
                    await updateDoc(playerRef, { loan: (d.loan || 0) + loanAmount, balance: (d.balance || 0) + loanAmount });
                    await addDoc(collection(db, `artifacts/${appId}/public/data/gameSessions/${currentSessionId}/transactions`), { playerName: modalPlayerName.textContent, action: 'Loan', amount: loanAmount, timestamp: serverTimestamp() });
                    alert(`${modalPlayerName.textContent} took a loan of $${loanAmount}.`);
                }
            } catch (error) { console.error("Error taking loan:", error); alert("Failed to take loan."); 
            } finally { takeLoanBtn.disabled = false; }
            loanAmountInput.value = '';
        }
        async function payday() { /* Function is unchanged */
            if (!currentPlayerIdInModal || !currentSessionId) { alert("No player selected."); return; }
            const playerRef = doc(db, `artifacts/${appId}/public/data/gameSessions/${currentSessionId}/players`, currentPlayerIdInModal);
            paydayBtn.disabled = true;
            try {
                let paidAmount = 0;
                let updatedData = {};
                await runTransaction(db, async (transaction) => {
                    const playerDoc = await transaction.get(playerRef);
                    if (!playerDoc.exists()) throw "Player not found.";
                    const playerData = playerDoc.data();
                    const salary = playerData.currentSalary || professionIncomes[playerData.profession] || 0;
                    paidAmount = salary;
                    let nextSalary = salary;
                    if (playerData.profession === 'BUSINESS-M') {
                        nextSalary += 1000;
                    }
                    updatedData = {
                        balance: (playerData.balance || 0) + salary,
                        currentSalary: nextSalary
                    };
                    transaction.update(playerRef, updatedData);
                });
                await addDoc(collection(db, `artifacts/${appId}/public/data/gameSessions/${currentSessionId}/transactions`), {
                    playerName: modalPlayerName.textContent, action: 'Paycheck', amount: paidAmount, timestamp: serverTimestamp()
                });
                alert(`${modalPlayerName.textContent} received $${paidAmount.toLocaleString()} for Payday!`);
                salaryDisplay.textContent = `$${updatedData.currentSalary.toLocaleString()}`;
            } catch (error) { console.error("Error during Payday:", error); alert("Failed to process Payday."); 
            } finally { paydayBtn.disabled = false; }
        }
        async function updateProfession(playerId, newProfession) { /* Function is unchanged */
            if (!playerId || !currentSessionId) return;
            const playerRef = doc(db, `artifacts/${appId}/public/data/gameSessions/${currentSessionId}/players`, playerId);
            try {
                const initialSalary = professionIncomes[newProfession] || 0;
                await updateDoc(playerRef, {
                    profession: newProfession,
                    currentSalary: initialSalary
                });
                alert(`Profession updated to ${newProfession}.`);
                const updatedPlayerSnap = await getDoc(playerRef);
                openPlayerModal({ id: updatedPlayerSnap.id, ...updatedPlayerSnap.data() });
            } catch (error) { console.error("Error updating profession:", error); alert("Failed to update profession."); }
        }
        
        async function invest() { /* Function is unchanged */
            if (!currentPlayerIdInModal || !currentSessionId) { alert("No player selected."); return; }
            const playerRef = doc(db, `artifacts/${appId}/public/data/gameSessions/${currentSessionId}/players`, currentPlayerIdInModal);
            const INVESTMENT_COST = 5000;
            const SALARY_INCREMENT = 4000;
            investBtn.disabled = true;
            try {
                let updatedSalary = 0;
                await runTransaction(db, async (transaction) => {
                    const playerDoc = await transaction.get(playerRef);
                    if (!playerDoc.exists()) throw "Player not found.";
                    const playerData = playerDoc.data();
                    if (playerData.profession !== 'BUSINESS-M') throw "Only BUSINESS-M players can invest.";
                    if ((playerData.balance || 0) < INVESTMENT_COST) throw `Insufficient funds for investment. Requires $${INVESTMENT_COST.toLocaleString()}.`;
                    
                    updatedSalary = (playerData.currentSalary || 0) + SALARY_INCREMENT;
                    transaction.update(playerRef, {
                        balance: playerData.balance - INVESTMENT_COST,
                        currentSalary: updatedSalary
                    });
                });
                await addDoc(collection(db, `artifacts/${appId}/public/data/gameSessions/${currentSessionId}/transactions`), {
                    playerName: modalPlayerName.textContent, action: 'Investment', amount: INVESTMENT_COST, timestamp: serverTimestamp()
                });
                salaryDisplay.textContent = `$${updatedSalary.toLocaleString()}`;
                alert(`Paid $${INVESTMENT_COST.toLocaleString()} to invest. New payday for ${modalPlayerName.textContent} is $${updatedSalary.toLocaleString()}.`);
            } catch (error) { console.error("Error during investment:", error); alert(`Failed to process investment: ${error}`); 
            } finally { investBtn.disabled = false; }
        }
        async function setInterestRate() { /* Function is unchanged */
            const newInterest = parseInt(interestRateInput.value, 10);
            if (isNaN(newInterest) || newInterest < 0) { alert("Please enter a valid interest rate."); return; }
            if (!currentPlayerIdInModal || !currentSessionId) return;
            const playerRef = doc(db, `artifacts/${appId}/public/data/gameSessions/${currentSessionId}/players`, currentPlayerIdInModal);
            setInterestBtn.disabled = true;
            try {
                await updateDoc(playerRef, { loanInterest: newInterest });
                alert(`Loan interest for ${modalPlayerName.textContent} set to ${newInterest}%.`);
            } catch (error) { console.error("Error setting interest rate:", error); alert("Failed to set interest rate."); 
            } finally { setInterestBtn.disabled = false; }
        }
        closeModalBtn.addEventListener('click', closeModal);
        sendMoneyBtn.addEventListener('click', sendMoney);
        takeLoanBtn.addEventListener('click', takeLoan);
        paydayBtn.addEventListener('click', payday);
        setInterestBtn.addEventListener('click', setInterestRate);
        investBtn.addEventListener('click', invest);
        window.onload = initializeFirebase;
    </script>
</body>
</html>
